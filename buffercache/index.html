<!DOCTYPE html>
<html>
    <head>
        <title>Buffer cache</title>
    </head>
    <body>
        <div>
        Upload a file: <input type="file" onchange="handleFile(this.files)">
        </div>
        <div id="buffercache">
            Show buffer cache here
        </div>

        <script src="DLList.js"></script>
        <script>
            DLList.prototype.getQHeaders = function() {
                var headers = [];
                var current = this[head];
                while ( current != null) {
                    headers.push({lno: current.data.lno});
                    current = current.next;
                }
                return headers;
            }

            limit = 10;
            hashQ = [];
            freelist = new DLList();
            belem = document.getElementById('buffercache');
            file = null;
            function hash(x) {
                return x%4;
            }
            addToHashQueue = ( {lno, data} ) => {
                var i = hash(lno) //Hash function
                if(!hashQ[i]) {
                    hashQ[i]=new DLList();
                }
                hashQ[i].add( {lno: lno, data: data} );
            };
            function init() {

                //All buffers are free and filled with garbage
                for(i=0;i<limit;i++) {
                    var buffer = {lno:i+1,data:null};
                    addToHashQueue(buffer);
                    freelist.add(buffer);
                }
                addToHashQueue = ()=>{return 0}; //remove addToHashQueue function
                refreshCacheUI();
            }
            init();
            function handleFile(files) {
                    file = files[0];

                    var reader = new FileReader();
                    reader.onload = function(e) {
                        const data = e.target.result;
                        const lines = data.split(/\r\n|\n/);
                        for(var j=0;j<limit/2;j++) {
                            //addToHashQueue( { lno: j+1,data: lines[j] } );
                            buffer = getblk()
                            buffer.data = lines[j];
                            buffer.lno = j+1;
                        }
                        refreshCacheUI();
                    }
                    reader.readAsText(file);
            }

            function getblk() {
                /* TODO: handle all scenarios */
                if(arguments.length == 0)
                    lno = null;
                //directly add
                if(lno == null) {
                    var buffer = freelist.popHead();
                    return buffer;
                } else {
                    /*return specific buffer*/
                }
            }

            function refreshCacheUI() {
                if(hashQ.length == 0) {
                    belem.innerHTML = "/buffer cache is empty/<br>Show buffer cache here"
                    return;
                }
                var op = "";
                for(var i=0;i<hashQ.length;i++) {
                    op += "<div class='hashq' id='hashq"+i+"'>";
                    op += "<div class='hashq_label'>"+i+"</div>";
                    op += "<div class='hashq_content'>";
                    if(hashQ[i]) {
                        var q = hashQ[i].getQHeaders();
                        //console.log(q, q.length);
                        for(j=0;j<q.length;j++) {
                            op += "<div class='hashq_elem'>";
                            op += "<div class='hashq_lno'>Line: "+q[j].lno+"</div>";
                            op += "<div class='hashq_datalabel'>data</div>";
                        }
                    }
                    op += "</div>";
                    op += "</div>";
                }
                belem.innerHTML = op;
            }
        </script>
    </body>
</html>